<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Lista de animes e mangás">
    <meta name="author" content="Edivaldo">
    <link rel="shortcut icon" href="./icones/icons8-naruto-sign-210.png" type="image/x-icon">

    <link rel="stylesheet" href="./anime.css">

    <title>Mangás</title>
</head>

<body>
    <!--Menu de navegação-->
    <nav>
        <a href="./index.html?pag=1" id="menu_anime">Anime</a>
        <a href="#" id="menu_manga">Mangá</a>
    </nav>

    <!--bara de pesquisa-->
    <div id="div_de_pesquisa">
        <form action="" method="get">
            <input type="search" name="" id="bara_de_pesquisa" placeholder="Pesquise">
        </form>
    </div>


    <h1>Minha lista de <span>Mangás</span></h1>

    <!--Tabela-->
    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>Autor</th>
            </tr>
        </thead>
        <tbody id="corpo_tabela_animes">

            <!--<tr>
                <td><a href="./detalhe.html">One Piece</a></td>
                <td>Aiichiro Oda</td>
            </tr>
            <tr>
                <td><a href="./detalhe.html">Fairy Tail</a></td>
                <td>Mashima</td>
            </tr>
            <tr>
                <td><a href="./detalhe.html">Noragami</a></td>
                <td>Hitome</td>
            </tr>
            <tr>
                <td><a href="./detalhe.html">Overlord</a></td>
                <td>Naoyuki</td>
            </tr>-->
        </tbody>


    </table>
    
    <!--Pagination-->
    <div class="pagination">
        <a href="#">&laquo;</a>
        <span class="pagination-wrapper" style="font-size: 1em;"></span>
        <a href="#">&raquo;</a>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script>

        function buildList() {
            var tabela = document.querySelector('table > tbody');


            var url = 'https://ani-mangalist.herokuapp.com/manga-list/'

            fetch(url)
                .then((resp) => resp.json())
                .then(function (data) {
                    console.log('Data:', data)
                    var manga = data
                    /*for (let i in manga) {
                        tabela.innerHTML += `<tr><td><a href="./detalhe.html?id=${manga[i].id}&tipo=manga">${manga[i].nome}</a></td><td>${manga[i].autor.nome}</td> </tr>`
                    }*/
                    function listarAnime(anime) {
                            for (let i in anime) {
                                tabela.innerHTML += `<tr><td><a href="./detalhe.html?id=${anime[i].id}&tipo=manga">${anime[i].nome}</a></td><td>${anime[i].autor.nome}</td> </tr>`
                            }
                        }

                    paginacao(anime = manga)


                    
                    // search bar

                    $('#bara_de_pesquisa').on('keyup', function () {
                        var value = $(this).val()
                        var data = searchTable(value, manga)
                        console.log('Value:', value)
                        console.log(data)
                        tabela.innerHTML = ''
                        console.log('data33:', data)
                        if (data.length == 0) {
                            tabela.innerHTML += `<tr><td colspan="2">Nenhum anime encontrado</td></tr>`
                        }
                        listarAnime(data)
                    })

                    function searchTable(value, data) {
                        var filteredData = []

                        for (var i = 0; i < data.length; i++) {
                            value = value.toLowerCase()
                            var name = data[i].nome.toLowerCase()

                            if (name.includes(value)) {
                                filteredData.push(data[i])
                            }
                        }

                        return filteredData
                    }





                    // paginação
                    function paginacao(anime) {
                        /*paginação*/
                        listarAnime(anime)

                        window.location.href + '?pag=1'


                        const params = new URLSearchParams(window.location.search);

                        const pag = parseInt(params.get("pag"));
                        console.log('pag', pag)
                        console.log(typeof (pag))

                        var state = {
                            'querySet': anime,
                            'page': pag,
                            'rows': 5,
                            'window': 3,
                        }
                        console.log('state', state.page)
                        var AniPage = pagination(state.querySet, state.page, state.rows)
                        listarAnime(anime = AniPage.querySet)

                        console.log('AnimePagination:', AniPage)



                        function pagination(querySet, page, rows) {
                            var triStart = (page - 1) * rows
                            var triEnd = triStart + rows

                            var trimedData = querySet.slice(triStart, triEnd)

                            var pages = Math.round(querySet.length / rows)

                            return {
                                'querySet': trimedData,
                                'pages': pages,
                            }
                        }

                        function pageButtons(pages) {
                            var wrapper = document.querySelector('.pagination-wrapper')

                            wrapper.innerHTML = ''

                            var maxLeft = (state.page - Math.floor(state.window / 2))
                            var maxRight = (state.page + Math.floor(state.window / 2))

                            if (maxLeft < 1) {
                                maxLeft = 1
                                maxRight = state.window
                            }
                            if (maxRight > pages) {
                                maxLeft = pages - (state.window - 1)
                                maxRight = pages

                                if (maxLeft < 1) {
                                    maxLeft = 1
                                }
                            }

                            for (let page = maxLeft; page <= maxRight; page++) {
                                wrapper.innerHTML += `<a href="?pag=${page}" class='pagbtn'>${page}</a>`
                            }
                            document.querySelectorAll('.pagination > a')[0].href = '?pag=1'
                            document.querySelectorAll('.pagination > a')[1].href = `?pag=${pages}`


                        }
                        pageButtons(AniPage.pages)
                        $(".pagbtn").click(function () {
                            tabela.innerHTML = ''
                            state.page = pag;
                            console.log('state', state.page)

                            listarAnime(anime = AniPage.querySet);
                        });
                        $('.pagbtn').each(function () {

                            if (pag == $(this).text()) {
                                $(this).addClass('active')
                            }
                        });
                    }



                })

        }

        buildList()

    </script>


</body>

</html>